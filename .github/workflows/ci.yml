name: ci

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Auto-cancel in-progress runs for the same branch/PR
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    # Skip CI for template bootstrap commits (first commit when repo is cloned from template)
    if: ${{ !contains(github.event.head_commit.message, '[initial-seed]') && !contains(github.event.head_commit.message, '[skip ci]') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npx tsc --noEmit

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  copilot-review:
    # Request Copilot code review on PRs (skip template commits)
    if: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.title, '[initial-seed]') }}
    runs-on: ubuntu-latest
    steps:
      - name: Request Copilot Review
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                reviewers: ['copilot-pull-request-reviewer[bot]']
              });
              console.log('Copilot review requested');
            } catch (e) {
              // Copilot review may not be available on all repos
              console.log('Could not request Copilot review:', e.message);
            }

  auto-merge:
    # Auto-merge PRs created by Glyphor AI after CI passes
    needs: [build]
    if: ${{ github.event_name == 'pull_request' }}
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge
        uses: actions/github-script@v7
        with:
          script: |
            // Enable auto-merge via GraphQL (requires branch protection with required checks)
            try {
              const result = await github.graphql(`
                mutation($pullRequestId: ID!) {
                  enablePullRequestAutoMerge(input: {
                    pullRequestId: $pullRequestId
                    mergeMethod: SQUASH
                  }) {
                    pullRequest { number }
                  }
                }
              `, {
                pullRequestId: context.payload.pull_request.node_id
              });
              console.log('Auto-merge enabled for PR #' + context.payload.pull_request.number);
            } catch (e) {
              console.log('GraphQL auto-merge not available, falling back to direct merge');
              // Fallback: directly merge if CI passed and no branch protection
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: context.payload.pull_request.number,
                  merge_method: 'squash'
                });
                console.log('PR #' + context.payload.pull_request.number + ' merged via fallback');
                // Delete the branch after successful merge
                try {
                  await github.rest.git.deleteRef({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    ref: 'heads/' + context.payload.pull_request.head.ref
                  });
                  console.log('Branch ' + context.payload.pull_request.head.ref + ' deleted');
                } catch (delErr) {
                  console.log('Branch deletion failed (non-fatal):', delErr.message);
                }
              } catch (mergeErr) {
                console.log('Direct merge failed (may need manual review):', mergeErr.message);
              }
            }
